{% extends 'base.html' %}
{% load bootstrap3 %}

{% block content %}
    <div cass="row">
        <form method="post" role="form">
            <h2>Publication
                <button type="button" class="btn btn-xs btn-primary" data-bind="click: savePublication"><i class="fa fa-floppy-o"></i> Save</button>
            </h2>
            <div class="col-md-12">
                <label class="control-label" for="id_title">Title</label>
                <input type="text" class="form-control" id="id_title" name="title" placeholder="Title" required="required" rows="2" data-bind="value: title" />
            </div>
            <div class="col-md-12">
                <label class="control-label" for="id_abstract">Abstract</label>
                <textarea class="form-control" id="id_abstract" name="abstract" placeholder="Abstract" required="required" rows="4" data-bind="value: abstract"></textarea>
            </div>
            <div class="col-md-12">
                <label class="control-label" for="id_short_title">Short title</label>
                <input class="form-control" id="id_short_title" maxlength="255" name="short_title" placeholder="Short title" type="text" data-bind="value: short_title">
            </div>
            <div class="col-md-12">
                <label class="control-label" for="id_journal">Journal</label>
                <select class="form-control" id="id_journal" name="journal" data-bind="selectize: journals, value: journal.name, optionsValue: 'name', options: { dropdownParent: 'body', create: true, closeAfterSelect: true, load: getJournalList }"></select>
            </div>

            <div class="col-md-4">
                <label class="control-label" for="id_url">Url</label>
                <input class="form-control" id="id_url" maxlength="200" name="url" placeholder="Url" type="url" data-bind="value: url" />
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_date_published">Date published</label>
                <input class="form-control" id="id_date_published" name="date_published" placeholder="Date published" type="text" data-bind="value: date_published">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_date_accessed">Date accessed</label>
                <input class="form-control" id="id_date_accessed" name="date_accessed" placeholder="Date accessed" type="text" data-bind="value: date_accessed">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_archive">Archive</label>
                <input class="form-control" id="id_archive" maxlength="255" name="archive" placeholder="Archive" type="text" data-bind="value: archive">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_archive_location">Archive location</label>
                <input class="form-control" id="id_archive_location" maxlength="255" name="archive_location" placeholder="Archive location" type="text" data-bind="value: archive_location">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_library_catalog">Library catalog</label>
                <input class="form-control" id="id_library_catalog" maxlength="255" name="library_catalog" placeholder="Library catalog" type="text" data-bind="value: library_catalog">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_call_number">Call number</label>
                <input class="form-control" id="id_call_number" maxlength="255" name="call_number" placeholder="Call number" type="text" data-bind="value: call_number">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_rights">Rights</label>
                <input class="form-control" id="id_rights" maxlength="255" name="rights" placeholder="Rights" type="text" data-bind="value: rights">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_extra">Extra</label>
                <input type="text" class="form-control" id="id_extra" name="extra" placeholder="Extra" data-bind="value: extra"/> 
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_published_language">Published language</label>
                <input class="form-control" id="id_published_language" maxlength="255" name="published_language" placeholder="Published language" required="required" type="text" data-bind="value: published_language">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_status">Status</label>
                <select class="form-control" id="id_status" name="status" data-bind="value: status">
                    <option value="UNTAGGED">Publication has not been curated or tagged yet</option>
                    <option value="INCOMPLETE">Curator has finished processing publication with no archive URL</option>
                    <option value="INVALID_URL">Curator has finished processing publication with invalid archive URL</option>
                    <option value="AUTHOR_UPDATED">Archive URL updated by author, needs curator review</option>
                    <option value="COMPLETE">Archive URL has been reviewed and verified</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_code_archive_url">Code archive url</label>
                <input class="form-control" id="id_code_archive_url" maxlength="255" name="code_archive_url" placeholder="Code archive url" type="url" data-bind="value: code_archive_url">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_contact_email">Contact email</label>
                <input class="form-control" id="id_contact_email" maxlength="75" name="contact_email" placeholder="Contact email" type="email" data-bind="value: contact_email">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_pages">Pages</label>
                <input class="form-control" id="id_pages" maxlength="255" name="pages" placeholder="Pages" type="text" data-bind="value: pages">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_issn">Issn</label>
                <input class="form-control" id="id_issn" maxlength="255" name="issn" placeholder="Issn" type="text" data-bind="value: issn">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_volume">Volume</label>
                <input class="form-control" id="id_volume" maxlength="255" name="volume" placeholder="Volume" type="text" data-bind="value: volume">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_issue">Issue</label>
                <input class="form-control" id="id_issue" maxlength="255" name="issue" placeholder="Issue" type="text" data-bind="value: issue">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_series">Series</label>
                <input class="form-control" id="id_series" maxlength="255" name="series" placeholder="Series" type="text" data-bind="value: series">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_series_title">Series title</label>
                <input class="form-control" id="id_series_title" maxlength="255" name="series_title" placeholder="Series title" type="text" data-bind="value: series_title">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_series_text">Series text</label>
                <input class="form-control" id="id_series_text" maxlength="255" name="series_text" placeholder="Series text" type="text" data-bind="value: series_text">
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_doi">Doi</label><input class="form-control" id="id_doi" maxlength="255" name="doi" placeholder="Doi" type="text" data-bind="value: doi">
            </div>

            <div class="col-md-4">
                <label class="control-label" for="id_platforms">Platforms</label>
                <select multiple="multiple" class="form-control" id="id_platforms" name="platforms" data-bind="selectize: platforms, selectedOptions: selected_platforms, optionsValue: 'name', options: { dropdownParent: 'body', create: true, closeAfterSelect: true, load: getPlatformList, create: function(input) { return { name: input, id: input }}}"></select>
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_sponsors">Sponsors</label>
                <select multiple="multiple" class="form-control" id="id_sponsors" name="sponsors" data-bind="selectize: sponsors, selectedOptions: selected_sponsors, optionsValue: 'name', options: { dropdownParent: 'body', create: true, closeAfterSelect: true, load: getSponsorList }"></select>
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_tags">Tags</label>
                <select multiple="multiple" class="form-control" id="id_tags" name="tags" data-bind="selectize: tags, selectedOptions: selected_tags, optionsText: 'value', optionsValue: 'value', options: { dropdownParent: 'body', create: true, closeAfterSelect: true, load: getTagList }"></select>
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_model_documentation">Model documentation</label>
                <select class="form-control" id="id_model_documentation" name="model_documentation" data-bind="selectize: model_docs, value: model_documentation.value, optionsText: 'value', optionsValue: 'value', options: { dropdownParent: 'body', create: true, closeAfterSelect: true, load: getModelDocList }"></select>
            </div>
            <!--div class="col-md-4">
                <label class="control-label" for="id_assigned_curator">Assigned curator</label>
                <select class="form-control" id="id_assigned_curator" name="assigned_curator" data-bind="selectize: assigned_curator"></select>
            </div>
            <div class="col-md-12">
                <label class="control-label" for="id_author_comments">Author comments</label>
                <textarea class="form-control" id="id_author_comments" name="author_comments" placeholder="Author comments" rows="2" data-bind="value: author_comments"></textarea>
            </div>
            <div class="col-md-4">
                <label class="control-label" for="id_creators">Creators</label>
                <select multiple="multiple" class="form-control" id="id_creators" name="creators" required="required">
                <option value="1604">Patrick Taillandier (AUTHOR)</option>
                </select>
            </div -->
            <div class="col-md-12">
                <button type="button" class="btn btn-primary" data-bind="click: savePublication"><i class="fa fa-floppy-o"></i> Save</button>
            </div>  
        </form>
    </div>
{% endblock content %}

{% block javascript %}

    <script type="text/javascript">
        var viewModelJson = $.parseJSON("{{ json | escapejs }}");
 
        $(function(){
            var PublicationDetail = function(data) {
                var self = this;
                ko.mapping.fromJS(data, {}, self);

                self.selected_tags = ko.observableArray(ko.utils.arrayMap(self.tags(), function(tag) { return tag.value(); }));
                self.selected_platforms = ko.observableArray(ko.utils.arrayMap(self.platforms(), function(platform) { return platform.name();}));
                self.selected_sponsors = ko.observableArray(ko.utils.arrayMap(self.sponsors(), function(sponsor) { return sponsor.name();}));
                self.journals = ko.observableArray([data.journal || "" ])
                self.model_docs = ko.observableArray([data.model_docmentation || ""])
 
                self.getPlatformList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, '/search/platform/?q=');
                };
                self.getSponsorList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, '/search/sponsor/?q=');
                };
                self.getTagList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, '/search/tag/?q=');
                };
                self.getJournalList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, '/search/journal/?q=');
                };
                self.getModelDocList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, '/search/modeldoc/?q=');
                };

                self.makeAsyncRequest = function(query, callback, url) {
                    if (!query.length) return callback();
                    $.getJSON(url + encodeURIComponent(query))
                        .done(function(res) {
                            callback(JSON.parse(res).slice(0, 5));
                        }).fail(function() { callback(); });
                    };

                self.savePublication = function(data, event) {
                    self.platforms(ko.utils.arrayMap(data.selected_platforms(), function(platform) {
                        return {'name': platform};
                    }));
                    self.sponsors(ko.utils.arrayMap(data.selected_sponsors(), function(sponsor) {
                        return {'name': sponsor};
                    }));
                    self.tags(ko.utils.arrayMap(data.selected_tags(), function(tag) {
                        return {'value': tag};
                    }));

                    $.ajax({
                        type: "PUT",
                        url: window.location.pathname,
                        data: ko.toJSON(data),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function(result) {
                            humane.log("Data save was success!!, {timeout: 5000}")
                        },
                        error: function(result) {
                            humane.log("Something went wrong, Please verify the from data and try again!!", {timeout: 5000});
                            console.log(result.responseJSON);
                        }
                    });
                };
            };
            ko.applyBindings(new PublicationDetail(viewModelJson));
        });
    </script>
{% endblock javascript %}
