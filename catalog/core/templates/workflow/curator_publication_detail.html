{% extends 'base.html' %}
{% load bootstrap3 %}
{% load static %}

{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class='panel-title'>
                <span class='label label-as-badge label-primary'><b>STATUS:</b> <span data-bind='text: status'></span></span>
                <a target='_blank' data-bind="attr: { href: googleScholarTitleLink() }">
                    <span data-bind='text: title'></span> <i class='fa fa-external-link'></i>
                </a>
            </h3>
        </div>
        <div class="panel-body clearfix">
            <form id='curatorPublicationDetailForm' method="post" role="form">
                <div class="row">
                    <div class="col-md-6">
                        <div class='panel panel-default'>
                            <div class='panel-heading'>
                                <h4 class='panel-title'>Assigned to
                                    <mark>
                                        <span data-bind='ifnot: assigned_curator'>nobody</span>
                                        <span data-bind='text: assigned_curator'></span>
                                    </mark>
                                </h4>
                            </div>
                            <div class='panel-body'>
                                <b>Journal:</b><span data-bind="text: journal.name"></span><br>
                                <b>Date Published:</b><span data-bind="text: date_published"></span><br>
                                <b>Last modified:</b> <span data-bind='text:date_modified'></span>
                                <div><b>Author(s):</b>
                                    <ul class='list-inline' data-bind="foreach: creators">
                                        <li><a target='_blank' data-bind='attr: { href: $root.googleScholarAuthorSearch($data) }'>
                                                <span data-bind="text: first_name"></span> <span data-bind="text: last_name"></span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <ul class='list-group'>
                                    <li class='list-group-item google-blue'>
                                        <i class='fa fa-graduation-cap'></i>
                                        <b>Google Scholar</b>
                                        <div class='btn-group'>
                                            <span class='btn'>
                                                <a target='_blank' data-bind="attr: { href: googleScholarTitleLink() }">
                                                    <i class='fa fa-pencil'></i> Title Only
                                                </a>
                                            </span>
                                            <span class='btn'>
                                                <a target='_blank' data-bind="attr: { href: googleScholarAuthorLink() }">
                                                    <i class='fa fa-pencil-square'></i> Title and Author
                                                </a>
                                            </span>
                                        </div>
                                    </li>
                                    <li class='list-group-item asu-maroon'>
                                        <i class='fa fa-university'></i>
                                        <b>ASU Libraries</b>
                                        <div class='btn-group'>
                                            <span style='margin-left: 13px;' class='btn'>
                                                <a target='_blank' data-bind='attr: { href: asuLibraryTitleLink() }'>
                                                    <i class='fa fa-pencil'></i>
                                                    Title Only
                                                </a>
                                            </span>
                                            <span class='btn'>
                                                <a target='_blank' data-bind='attr: { href: asuLibraryAuthorLink() }'>
                                                    <i class='fa fa-pencil-square'></i>
                                                    Title and Author
                                                </a>
                                            </span>
                                        </div>
                                    </li>
                                    <li class='list-group-item'>
                                        {# FIXME: dirty, hard-coded URL #}
                                        <a data-bind="attr:{ href: '/publication/'+ id()}">View full bibliographic record</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <note-detail params="notes: notes, pub_id: id"></note-detail>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-12'>
                        <div class='panel-group' id='activity-accordion' role='tablist' aria-multiselectable='false'>
                            <div class='panel panel-default'>
                                <div class='panel-heading'><h5 class='panel-title'><i class='fa fa-history'></i> Activity Log</h5></div>
                                <div class='panel-body' data-bind='foreach: activity_logs'>
                                    <p>
                                    <span class='pull-right label label-as-badge label-info' data-bind='text: date_added'></span>
                                    <mark data-bind='text: creator'></mark>
                                    <span data-bind='text: message'></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class='col-md-6 form-group'>
                        <label class="control-label" for="id_model_documentation">Model documentation</label>
                        <label for='model_documentation_none'>
                            <input type='checkbox' id='model_documentation_none' data-bind='click: clearModelDocumentation, checked: hasNoModelDocumentation'>None
                        </label>
                        <select multiple class="form-control" id="id_model_documentation" name="model_documentation"
data-bind="selectize: modelDocumentationCategoryLists, selectedOptions: selectedModelDocumentations, optionsValue: 'name', options: { optgroups: modelDocumentationCategories(), optgroupField: 'category', optgroupLabelField: 'category', optgroupValueField: 'category', options: modelDocumentationCategoryLists(), plugins: ['optgroup_columns']}">
                        </select>
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="control-label" for="id_platforms">Platforms</label>
                        <select multiple class="form-control" id="id_platforms" name="platforms"
                            data-bind="selectize: platforms, selectedOptions: selectedPlatforms, optionsValue: 'name', options: { create: true, load: getPlatformList, create: function(input) { return { name: input, id: input }}}">
                        </select>
                    </div>
                </div>
                <div class='row'>
                    <div class="col-md-12 form-group">
                        <label class="control-label" for="id_sponsors">Sponsors</label>
                        <select multiple class="form-control" id="id_sponsors" name="sponsors"
                            data-bind="selectize: sponsors, selectedOptions: selectedSponsors, optionsValue: 'name', options: { create: true, load: getSponsorList }">
                        </select>
                    </div>
                </div>
                <div class='row'>
                    <div class="col-md-12 form-group">
                        <label class="control-label" for="id_tags">Tags</label>
                        <select multiple class="form-control" id="id_tags" name="tags"
                            data-bind="selectize: tags, selectedOptions: selectedTags, optionsValue: 'name', options: { create: true, load: getTagList }">
                        </select>
                    </div>
                </div>
                <div class='row'>
                    <div class='col-md-12 form-group'>
                        <label class="control-label" for="id_code_archive_url">Code Archive URL</label>
                        <div class='input-group'>
                            <span class='input-group-addon'><i class='fa fa-code'></i> </span>
                            <input class="form-control" id="id_code_archive_url" maxlength="255" name="code_archive_url" placeholder="Code archive url" type="url" data-bind="value: code_archive_url">
                            <span class='input-group-addon'>
                                <a target='_blank' data-bind='css: { disabled: ! validCodeArchiveUrl() }, attr: {href: codeArchiveUrl()}'>Open <i class='fa fa-external-link'></i></a>
                            </span>
                        </div>
                    </div>
                </div>
                <div class='row'>
                    <div class="col-md-6 form-group">
                        <label class="control-label" for="id_contact_author">Contact author name</label>
                        <input class="form-control" id="id_contact_author" maxlength="75" name="contact_author" placeholder="Corresponding Author" type="text" data-bind="value: contact_author_name">
                    </div>
                    <div class="col-md-6 form-group">
                        <label class="control-label" for="id_contact_email">Contact email</label>
                        <input class="form-control" id="id_contact_email" maxlength="75" name="contact_email" placeholder="Contact email" type="email" data-bind="value: contact_email">
                    </div>
                </div>
                <div class='row'>
                    <div class='col-sm-12 form-group'>
                        <div class='well'>
                        <span class="label label-as-badge-lg label-primary">Current Status: <b data-bind='text:status'></b></span>
                        <br>
                        <div class="radio" data-toggle="buttons">
                            <label class="btn btn-info btn-sm">
                                <input type="radio" name="status" value="UNTAGGED" data-bind="bsChecked: status"> <i class='fa fa-eye-slash'></i> Incomplete
                            </label>
                            <label class="btn btn-warning btn-sm">
                                <input type="radio" name="status" value="NEEDS_AUTHOR_REVIEW" data-bind="bsChecked: status"> <i class='fa fa-tag'></i> Tagging Complete, Needs Author Input
                            </label>
                            <label class="btn btn-success btn-sm">
                                <input type="radio" name="status" value="COMPLETE" data-bind="bsChecked: status"> <i class='fa fa-thumbs-o-up'></i> Tagging Complete, Code Archived
                            </label>
                            <label class="btn btn-danger btn-sm">
                                <input type="radio" name="status" value="INVALID" data-bind="bsChecked: status"> <i class='fa fa-times'></i> Invalid Publication
                            </label>
                            <label class="btn btn-danger btn-sm">
                                <input type="radio" name="status" value="FLAGGED" data-bind="bsChecked: status"> <i class='fa fa-flag'></i> Flag for Additional CoMSES Review
                            </label>
                        </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" data-bind="click: savePublication"><i class="fa fa-floppy-o"></i> Save</button>
                <a class='btn btn-default' href='{% url 'core:curator_workflow' %}'><i class='fa fa-arrow-left'></i> Back to assigned publications</a>
            </form>
        </div>
    </div>
{% endblock content %}

{% block javascript %}
    {% include "includes/note_form.html" %}

    <script type="text/javascript">
        var viewModelJson = $.parseJSON("{{ json | escapejs }}");
        if (!viewModelJson.journal) {
            viewModelJson.journal = {'name': null};
        }
        if (!viewModelJson.model_documentation) {
            viewModelJson.model_documentation = {'name': null};
        }
        $(function() {
            var PublicationDetail = function(data) {
                var self = this;
                ko.mapping.fromJS(data, {}, self);

                self.hasNoModelDocumentation = ko.observable(false);
                if (self.model_documentation().length === 1) {
                    md = self.model_documentation()[0];
                    console.debug(md.name());
                    if (md.name() == 'None') {
                        console.debug("yeah");
                        self.hasNoModelDocumentation(true);
                    }
                }
                self.clearModelDocumentation = function() {
                    self.selectedModelDocumentations([]);
                    return true;
                };
                self.modelDocumentationCategories = ko.observableArray({{model_documentation_categories_json|safe}});
                self.modelDocumentationCategoryLists = ko.pureComputed(function() {
                    var list = [];
                    ko.utils.arrayForEach(self.modelDocumentationCategories(), function(mdc) {
                        list = list.concat(mdc.modelDocumentationList);
                    });
                    return list;
                });
                self.modelDocumentationList = ko.observableArray({{model_documentation_list_json|safe}});
                self.selectedTags = ko.observableArray(ko.utils.arrayMap(self.tags(), function(tag) { return tag.name(); }));
                self.selectedPlatforms = ko.observableArray(ko.utils.arrayMap(self.platforms(), function(platform) { return platform.name();}));
                self.selectedSponsors = ko.observableArray(ko.utils.arrayMap(self.sponsors(), function(sponsor) { return sponsor.name();}));
                self.selectedModelDocumentations = ko.observableArray(ko.utils.arrayMap(self.model_documentation(), function(md) { 
                    return md.name(); 
                }));
                self.journals = ko.observableArray([data.journal || ""]);
                self.googleScholarAuthorSearch = function(creator) {
                    return ko.pureComputed(function() {
                        return $.urls.SEARCH_GOOGLE_SCHOLAR 
                            + "&as_sauthors=" 
                            + encodeURIComponent(creator.first_name() + ' ' + creator.last_name());
                    });
                };
                self.authorLastNames = ko.pureComputed(function() {
                    return ko.utils.arrayMap(self.creators(), function(creator) { return creator.last_name() }).join(' ');
                });
                self.googleScholarTitleLink = ko.pureComputed(function() {
                    return $.urls.SEARCH_GOOGLE_SCHOLAR + encodeURIComponent(self.title());
                });
                self.googleScholarAuthorLink = ko.pureComputed(function() {
                    return $.urls.SEARCH_GOOGLE_SCHOLAR + encodeURIComponent(self.title()) +
                        '&as_sauthors=' + encodeURIComponent(self.authorLastNames());
                });
                self.asuLibraryTitleLink = ko.pureComputed(function() {
                    return 'http://asu.summon.serialssolutions.com/search/results?q=' + encodeURIComponent(self.title());

                });
                self.asuLibraryAuthorLink = ko.pureComputed(function() {
                    return 'http://asu.summon.serialssolutions.com/search/results?q=' + encodeURIComponent(self.title())
                        +  encodeURIComponent(' AND (AuthorCombined: (' + self.authorLastNames() + '))');

                });
                self.validCodeArchiveUrl = ko.pureComputed(function() {
                    url = self.code_archive_url();
                    return url && validator.isURL(url);
                });
                self.codeArchiveUrl = ko.pureComputed(function() {
                    if (self.validCodeArchiveUrl()) {
                        return self.code_archive_url();
                    }
                    return '#id_code_archive_url';
                });
                self.getPlatformList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, "{% url 'core:platform_search' %}");
                };
                self.getSponsorList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, "{% url 'core:sponsor_search' %}");
                };
                self.getTagList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, "{% url 'core:tag_search' %}");
                };
                self.getJournalList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, "{% url 'core:journal_search' %}");
                };
                self.getModelDocumentationList = function(query, callback) {
                    self.makeAsyncRequest(query, callback, "{% url 'core:model_documentation_search' %}");
                };

                self.makeAsyncRequest = function(query, callback, url) {
                    if (!query.length) return callback();
                    $.getJSON(url + "?q=" + encodeURIComponent(query))
                        .done(function(res) {
                            callback(JSON.parse(res).slice(0, 5));
                        }).fail(function() { callback(); });
                };
                {# FIXME: code duplication #}
                self.makeRequest = function(request_type, data, url) {
                     return $.ajax({
                        type: request_type,
                        url: url,
                        data: data,
                        dataType: "json",
                        contentType: "application/json; charset=utf-8"
                    }).fail(function(result) {
                        humane.log("Something went wrong, Please verify the form data and try again.", {timeout: 5000});
                        console.log(result.responseJSON);
                    });
                }
                self.savePublication = function(data, event) {
                    {% comment "FIXME: Add client-side validation " %}
                    var form = $('#curatorPublicationDetailForm');
                    if ( !form.valid() ) {
                        form.showErrors();
                        return false;
                    }
                    {% endcomment %}
                    var data_clone = ko.mapping.fromJS(ko.mapping.toJS(data));
                    data_clone.platforms(ko.utils.arrayMap(data.selectedPlatforms(), function(platform) {
                        return {'name': platform};
                    }));
                    data_clone.sponsors(ko.utils.arrayMap(data.selectedSponsors(), function(sponsor) {
                        return {'name': sponsor};
                    }));
                    data_clone.tags(ko.utils.arrayMap(data.selectedTags(), function(tag) {
                        return {'name': tag};
                    }));
                    if (data.selectedModelDocumentations().length > 0) {
                        data_clone.model_documentation(ko.utils.arrayMap(data.selectedModelDocumentations(), function(md) {
                            return {'name': md};
                        }));
                        data.hasNoModelDocumentation(false);
                    }
                    else if (data.hasNoModelDocumentation()) {
                        data_clone.model_documentation([{'name': 'None'}]);
                    }
                    if (data_clone.journal.name() == undefined) {
                        if (data.journals()[0].name) {
                            data_clone.journal.name = ko.observable(data.journals()[0].name);
                        } else {
                            data_clone.journal = null;
                        }
                    } else if (data_clone.journal.name() == "") {
                        data_clone.journal = null
                    }
                    self.makeRequest("PUT", ko.toJSON(data_clone), window.location.pathname).done(function(result) {
                        ko.mapping.fromJS(result, self);
                        humane.log("Data saved successfully.", {timeout: 5000});
                    });
                };
            };
            var model = new PublicationDetail(viewModelJson);
            ko.applyBindings(model);
        });
    </script>
{% endblock javascript %}
